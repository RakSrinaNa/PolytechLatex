\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{polytech/references}[\polytechfiledate\space\polytechfileversion\space Polytech document class sub package]
\typeout{Package `polytech references' \polytechfileversion\space<\polytechfiledate>}

%###
 
% declare new properties
\zref@newprop{chapter}[]{}
\zref@newprop{chapternumber}[]{}
\zref@newprop{isappendix}{}
\zref@newprop{issection}{}
\zref@newprop{isappendices}{}
\zref@newprop{isdefined}[]{}
\zref@addprop{main}{chapter}
\zref@addprop{main}{chapternumber}
\zref@addprop{main}{isappendix}
\zref@addprop{main}{issection}
\zref@addprop{main}{isappendices}
\zref@addprop{main}{isdefined}

% remove chapter from section, subsection...
\renewcommand{\thesection}{\arabic{section}}
\renewcommand{\thetable}{\arabic{table}}
\renewcommand{\thefigure}{\arabic{figure}}
\renewcommand{\theequation}{\arabic{equation}}

% get the reference without the chapter part
\newcommand{\shortref}[1]{\polytech@oldref{#1}}

\newcounter{polytech@chapter@countertemp}

% get the chapter part of the reference
\newcommand{\polytech@ref@refchapter}[1]{%
		\zref@def@extract{\polytech@ref@chapter}{#1}{chapter}%
		\zref@def@extract{\polytech@ref@issection}{#1}{issection}%
		\zref@def@extract{\polytech@ref@chapternumber}{#1}{chapternumber}%
		\zref@def@extract{\polytech@ref@isappendix}{#1}{isappendix}%
		\ifcsempty{polytech@ref@chapter}%
	  {% no number defined
	   \setcounter{polytech@chapter@countertemp}{\csuse{polytech@ref@chapternumber}}%
	   \ifnumequal{\value{polytech@chapter@countertemp}}{\value{polytech@chapter@counter}}%
      {% same chapter => no problem if it is a section
        \ifcsempty{polytech@ref@issection}{%
          \errmessage{You can not self reference this unnumbered chapter.}%
        }{%
        }%
      }%
      {% no number but different chapter => error
        \errmessage{You can not reference things in unnumbered chapter from outside the chapter.}%
      }%
	  }%
	  {%
	    \ifcsequal{polytech@ref@chapternumber}{thepolytech@chapter@counter}%
	    {% same chapter, keep short numbering
	    }%
	    {%
	      \ifcsempty{polytech@ref@isappendix}%
	      {%
	      	\csuse{polytech@ref@from@chapter@\polytech@lang}{\polytech@ref@chapter}%
	      }%
	      {%
	        \csuse{polytech@ref@from@appendix@\polytech@lang}{\polytech@ref@chapter}%
	      }%
	      \xspace%
	    }%
	  }%
}

% Get the chapter/appendix of ref
\newcommand{\refchapterof}[1]{
	\zref@def@extract{\polytech@ref@chapter}{#1}{chapter}%
	\zref@def@extract{\polytech@ref@chapternumber}{#1}{chapternumber}%
	\zref@def@extract{\polytech@ref@isappendix}{#1}{isappendix}%
	\zref@def@extract{\polytech@ref@issection}{#1}{issection}%
	\ifcsempty{polytech@ref@chapternumber}{%
    \protect\G@refundefinedtrue%
    \nfss@text{\reset@font\bfseries ??}%
    \@latex@warning{%
      Reference `#1' on page \thepage\space undefined%
    }%
    \errmessage{Can not compute referenced chapter from undefined reference.}% 
	}{%
		\ifcsempty{polytech@ref@chapter}%
	  {% no number defined
	  	\errmessage{Can not compute referenced chapter from unnumbered chapter.}%
	  }%
	  {%
	    \ifcsempty{polytech@ref@issection}{
	     \errmessage{Only sections can be referenced using \string\refchapterof.}
	    }{%
  	    \ifcsempty{polytech@ref@isappendix}%
  	    {%
  	    	\hyperref[#1]{\csuse{polytech@ref@name@chapter@\polytech@lang}{\polytech@ref@chapter}}%
  	    }%
  	    {%
  	      \hyperref[#1]{\csuse{polytech@ref@name@appendix@\polytech@lang}{\polytech@ref@chapter}}%
  	    }%
  	    \xspace%
  	  }%
	  }%
	}{}%
}

% redefine label to store additional data with zref
\newcommand{\polytech@zlabel}[1]{%
  \zref@setcurrent{isappendices}{\ifbool{polytech@ref@inchapter}{}{1}}%
  \zref@setcurrent{issection}{\ifbool{polytech@ref@section}{1}{}}%
  \zref@setcurrent{chapter}{\ifbool{polytech@ref@unnumberedchapter}{}{\thechapter}}%
  \zref@setcurrent{chapternumber}{\csuse{thepolytech@chapter@counter}}%
	\zref@setcurrent{isappendix}{\ifbool{polytech@ref@appendix}{1}{}}%
	\zref@setcurrent{isdefined}{1}%
	\ifbool{polytech@ref@appendix}{%
    \ifbool{polytech@ref@inchapter}{%
      % in appendix chapter
    }{%
      % in appendices => not allowed here
      \polytechfatalerror{You can not define a label in appendices outside a chapter. \string\label is forbidden here.}%
    }%
	}{}%
  \zlabel{#1}%
}

% redefine label to store additional data with zref
\newcommand{\polytech@label}[1]{%
	\polytech@oldlabel{#1}%
  \polytech@zlabel{#1}%
}

% boolean used to not include chapter in autoref
\newbool{polytech@ref@nochapter}

% def used to not include chapter in ref
\csdef{polytech@ref@nochapter@chapter}{}
\csdef{polytech@ref@nochapter@part}{}
\csdef{polytech@ref@nochapter@appendix}{}

%\Hy@SetCatcodes

\def\polytech@ref@type#1.#2\\{#1}

\DeclareRobustCommand{\polytech@ref@newref}{%
	\leavevmode%
	\polytech@ref@newrefx%
}

\def\polytech@ref@newrefx#1{%
	\begingroup%
		\shortref{#1}%
		\Hy@safe@activestrue%
		\expandafter\polytech@ref@addchapter \csname r@#1\endcsname{#1}%
	\endgroup%
}

\def\polytech@ref@addchapter#1#2{%
	\ifcase 0\ifx#1\relax 1\fi\ifx#1\Hy@varioref@undefined 1\fi\relax%
		\edef\polytech@ref@thisref{%
	      \expandafter\@fourthoffive#1\@empty\@empty\@empty%
	  }%
	  \edef\polytech@ref@thistype{\expandafter\polytech@ref@type \polytech@ref@thisref\\}%
	  \Hy@safe@activesfalse%
		\ifcsdef{polytech@ref@nochapter@\polytech@ref@thistype}{}{\polytech@ref@refchapter{#2}}%
  \fi%
}

\def\polytech@ref@eqref#1{%
	\begingroup%
		\Hy@safe@activestrue%
		\expandafter\polytech@ref@eqrefx \csname r@#1\endcsname{#1}%
	\endgroup%
}

\def\polytech@ref@eqrefx#1#2{%
	\ifcase 0\ifx#1\relax 1\fi\ifx#1\Hy@varioref@undefined 1\fi\relax%
		\edef\polytech@ref@thisref{%
	      \expandafter\@fourthoffive#1\@empty\@empty\@empty%
	  }%
	  \edef\polytech@ref@thistype{\expandafter\polytech@ref@type \polytech@ref@thisref\\}%
	  \Hy@safe@activesfalse%
		\ifcsdef{polytech@ref@isequation@\polytech@ref@thistype}{%
			\textup{\tagform@{\polytech@oldref{#2}}}\polytech@ref@refchapter{#2}%
		}{%
			\textbf{#2 n'est pas une Ã©quation.}%
		}%
  \fi%
}

% allow eqref on equation
\csdef{polytech@ref@isequation@equation}{}

\AtBeginDocument{

	\let\polytech@oldref\ref
	\let\polytech@oldautoref\autoref
	\let\polytech@oldlabel\label
	\let\polytech@oldlabel@in@display\label@in@display
	
	\csshow{autoref}

	% replace Tableau by Table in caption, correct case
	\def\tableautorefname{Table}
	\def\sectionautorefname{Section}
	\ifbool{polytech@english}{
		\def\chapterautorefname{Chapter}
		\def\appendixautorefname{Appendix}
		\def\algorithmautorefname{Algorithm}
	}{
		\def\chapterautorefname{Chapitre}
		\def\appendixautorefname{Annexe}
		\def\algorithmautorefname{Algorithme}
	}

	% hide chapter from part and chapter
	\appto\partautorefname{\global\booltrue{polytech@ref@nochapter}}
	\appto\chapterautorefname{\global\booltrue{polytech@ref@nochapter}}
	\appto\appendixautorefname{\global\booltrue{polytech@ref@nochapter}}

	% replace standard \ref command
	\renewcommand{\ref}[1]{\polytech@ref@newref{#1}}
	\robustify{\ref}
	
	% complete autoref with the chapter part
	\renewcommand{\autoref}[1]{% 	  
		\boolfalse{polytech@ref@nochapter}%
		\polytech@oldautoref{#1}\relax%
		\ifbool{polytech@ref@nochapter}{}{\polytech@ref@refchapter{#1}}%
	}
	\robustify{\autoref} 

	% replace standard \label command
	\renewcommand{\label}[1]{\polytech@label{#1}}
	\robustify{\label}

	% amsmath replace label in equation, so we patch the replacement :)
	\renewcommand{\label@in@display}[1]{\polytech@oldlabel@in@display{#1}\relax\polytech@zlabel{#1}}

	% patch \eqref to move the chapter part outside the parenthesis
	\renewcommand{\eqref}[1]{\polytech@ref@eqref{#1}}
	\robustify{\eqref}

	% \nocite is fordibben
	\csundef{nocite}
}

%###



